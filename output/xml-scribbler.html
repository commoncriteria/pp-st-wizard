<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <meta content="text/html;charset=utf-8" http-equiv="Content-Type"></meta>
      <meta content="utf-8" http-equiv="encoding"></meta>

      <title>XML Scratchpad</title>

      <link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css"></link>
      <link rel="stylesheet" href="https://codemirror.net/doc/docs.css"></link>
      <link rel="stylesheet" href="https://codemirror.net/addon/hint/show-hint.css"></link>
      <style>
          [draggable=true] {
            cursor: move;
          }

.resizable {
  overflow: scroll;
  resize: both;
  max-width: 100%;
  max-height: 460px;
  border: 1px solid black;
  min-width: 50px;
  min-height: 50px;
  background-color: skyblue;
          }
      </style>

      <!-- Create a simple CodeMirror instance -->
      <script src="https://codemirror.net/lib/codemirror.js" type="text/javascript"></script>
      <script src="https://codemirror.net/mode/xml/xml.js" type="text/javascript"></script>
      <script src="https://codemirror.net/addon/hint/show-hint.js" type="text/javascript"></script>
      <script src="https://codemirror.net/addon/hint/xml-hint.js"  type="text/javascript"></script>

      <script src="https://syssgx.github.io/xml.js/js/xmllint.js" type="text/javascript"></script>
      <script type="text/javascript"> 
      /* <![CDATA[ */
      var xml_tbox;
      var schema_text = 
         "<grammar xmlns='http://relaxng.org/ns/structure/1.0'>\
   <start>\
      <element name='book'>\
         <oneOrMore>\
            <ref name='page'/>\
         </oneOrMore>\
      </element>\
   </start>\
   <define name='page'>\
      <element name='page'>\
         <text/>\
      </element>\
   </define>\
</grammar>";
      function handleOnLoad(){
          var xml_input = document.getElementById('xml_input');
          xml_tbox = CodeMirror.fromTextArea(xml_input, {
	         lineNumbers: true,
	         mode: "xml",
             hintOptions: {schemaInfo: tags},
              extraKeys: {
               "F11": handleValidateClick,
                 "'<'": completeAfter,
               "'/'": completeIfAfterLt,
               "' '": completeIfInTag,
               "'='": completeIfInTag,
               "Ctrl-Space": "autocomplete"
             },
	      });
          xml_tbox.setSize("100%", "200px");
          if (typeof(Storage) !== "undefined") {
              var prev_content = sessionStorage.getItem("xml_content");
              if (prev_content != null) xml_tbox.setValue(prev_content);
              var size = sessionStorage.getItem("codebox_size");
              if (size != null) xml_tbox.setSize(null, size+"px");
//             alert("We have storage.");// Code for localStorage/sessionStorage.
          }

      }
      function scrollCodeTo(num){
         xml_tbox.setCursor({line: num-1});
      }
          
      function handleValidateClick(){
         var args = {};
	     args.xml=xml_tbox.getValue();
         sessionStorage.setItem("xml_content", args.xml);
         args.schema= schema_text;
         args.arguments =["--noout", "--relaxng", "schema", "text"];
         var results = validateXML(args);
         results = results.replace(/^text\:(\d+)\:/g, "<span style='bgcolor: blue' onclick='scrollCodeTo($1)'>input:$1:</span> ")
         document.getElementById("output").innerHTML = results;
         
      }

      var dummy = {
        attrs: {
          color: ["red", "green", "blue", "purple", "white", "black", "yellow"],
          size: ["large", "medium", "small"],
          description: null
        },
        children: []
      };

      var tags = {
        "!top": ["top"],
        "!attrs": {
          id: null,
          class: ["A", "B", "C"]
        },
        top: {
          attrs: {
            lang: ["en", "de", "fr", "nl"],
            freeform: null
          },
          children: ["animal", "plant"]
        },
        animal: {
          attrs: {
            name: null,
            isduck: ["yes", "no"]
          },
          children: ["wings", "feet", "body", "head", "tail"]
        },
        plant: {
          attrs: {name: null},
          children: ["leaves", "stem", "flowers"]
        },
        wings: dummy, feet: dummy, body: dummy, head: dummy, tail: dummy,
        leaves: dummy, stem: dummy, flowers: dummy
      };
      function completeAfter(cm, pred) {
        var cur = cm.getCursor();
        if (!pred || pred()) setTimeout(function() {
          if (!cm.state.completionActive)
            cm.showHint({completeSingle: false});
        }, 100);
        return CodeMirror.Pass;
      }

      function completeIfAfterLt(cm) {
        return completeAfter(cm, function() {
          var cur = cm.getCursor();
          return cm.getRange(CodeMirror.Pos(cur.line, cur.ch - 1), cur) == "<";
        });
      }

      function completeIfInTag(cm) {
        return completeAfter(cm, function() {
          var tok = cm.getTokenAt(cm.getCursor());
          if (tok.type == "string" && (!/['"]/.test(tok.string.charAt(tok.string.length - 1)) || tok.string.length == 1)) return false;
          var inner = CodeMirror.innerMode(cm.getMode(), tok.state).state;
          return inner.tagName;
        });
      }

      function handleSizeChange(){
          var siz = document.getElementById("sizeField").value;
          xml_tbox.setSize(null, siz);
          localStorage.setItem("codebox_size", siz);      
      }
          
      /* ]]>*/

    </script>
  </head>
  <body onload="handleOnLoad()">
     <input title="Size" id="sizeField" type="text" onchange="handleSizeChange();"/> 
      <br/>
      <button onclick="handleValidateClick()">Validate</button>
      <div id="output" class="resizable"></div>
     <br/>    
    <textarea rows="10"  id="xml_input"></textarea>
      
  </body>
</html>